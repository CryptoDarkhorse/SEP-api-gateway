<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" type="image/png" href="./assets/img/aws-api-gateway.svg">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="theme-color" content="#AB47BC">
    <title>
        API Gateway Configuration
    </title>
    <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport'/>
    <meta name="description" content="Lotus Software is a software company based on Colombo, Sri Lanka."/>
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
          href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons"/>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">
    <!-- CSS Files -->
    <link href="./assets/css/material-kit.css?v=2.0.7" rel="stylesheet"/>
    <style> /* set the CSS */
    article{
        font: 12px Arial;
    }

    path {
        stroke: steelblue;
        stroke-width: 2;
        fill: none;
        font: 12px Arial;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: grey;
        stroke-width: 1;
        shape-rendering: crispEdges;
        font: 12px Arial;
    }
    #icon{
        width:5%; /* you can use % */
        height: 5%;
    }

    </style>


</head>
<body>
<div class="section text-center">
    <img src="assets/img/aws-api-gateway.svg" id="icon"><h2 class="h1">API Gateway Configuration</h2>
    <br><br>
</div>
<div class="main main-raised" id="info">
    <div class="container">
        <div class="row"><h2 class="h2">Configured Routes</h2></div>

        <div class="row" id="configuredRoutes">

<!--            <div class="col-md-5">-->
<!--                <div class="card">-->
<!--                    <table class="table table-stripe">-->
<!--                        <tr><td>Name</td><td>doctor</td></tr>-->
<!--                        <tr><td>Target</td><td>https://doctor-module.herokuapp.com/</td></tr>-->
<!--                        <tr><td>changeOrigin</td><td>true</td></tr>-->
<!--                        <tr><td>ws</td><td>true</td></tr>-->
<!--                        <tr><td>pathRewrite:</td><td></td></tr>-->
<!--                        <tr><td>^/doctor/</td><td>/</td></tr>-->
<!--                        <tr><td><input class="btn btn-danger" type="button" value="Delete Route"></td><td></td></tr>-->
<!--                    </table>-->
<!--                </div>-->
<!--            </div>-->





        </div>


        <div class="row">
            <h3>Add a new route</h3>
        </div>
        <div class="row">
            <div class="col-md-5">
                <div class="card">
                    <table class="table-stripe">
                        <tr><td>Target</td><td><input type="text" placeholder="target" id="route-target"></td></tr>
                        <tr><td>changeOrigin</td><td><input type="text" placeholder="true/false" id="route-changeOrigin"></td></tr>
                        <tr><td>ws</td><td><input type="text" placeholder="true/false" id="route-ws"></td></tr>
                        <tr><td>pathRewrite:</td></tr>
                        <tr><td><input type="text" placeholder="from path" id="route-pathKey"></td><td><input type="text" placeholder="to path" id="route-pathVal"></td></tr>
                        <tr><td><input type="button" value="Add Route" class="btn btn-default" onclick="addNewRoute()"></td><td></td></tr>
                    </table>

                </div>
            </div>


        </div>
        <hr class="hr">

        <div class="row"><h2>IP filtering</h2></div>
        <div class="row"><h3>Blacklisted IPs</h3></div>
        <div class="container">
            <div class="row">
                <ul class="list-inline" id="blackList">
<!--                    <li>efvgbthnyju</li>-->
<!--                    <li>cdfgb</li>-->
                </ul>
            </div>
        </div>
        <div class="row">
            <table>
                <tr>
                    <td><input class="btn btn-info" type="button" value="Add new ip to blacklist" onclick="addIPtoBlackList()"></td>
                    <td>&nbsp;&nbsp;&nbsp;<input type="text" id="addBlackListIp" placeholder="ip"></td>

                </tr>
                <tr>
                    <td><input class="btn btn-info" type="button" value="Remove IP from blacklist" onclick="removeIPFromBlackList()"></td>
                    <td>&nbsp;&nbsp;&nbsp;<input type="text" id="removeBlackListIp" placeholder="ip" ></td>
                </tr>
            </table>
        </div>

        <div class="row"><h3>Whitelisted IPs</h3></div>
        <div class="row">
            <ul class="list-inline" id="whiteList">
<!--                <li>dfghjk</li>-->
<!--                <li>hgjytfgvc</li>-->
            </ul>
        </div>

        <div class="row">
            <table>
                <tr>
                    <td><input class="btn btn-warning" type="button" value="Add new ip to whitelist" onclick="addIPtoWhiteList()"></td>
                    <td>&nbsp;&nbsp;&nbsp;<input type="text" id="addWhiteListIp" placeholder="ip" ></td>

                </tr>
                <tr>
                    <td><input class="btn btn-warning" type="button" value="Remove IP from whitelist" onclick="removeIPFromWhitelist()"></td>
                    <td>&nbsp;&nbsp;&nbsp;<input type="text" id="removeWhiteListIp" placeholder="ip" ></td>
                </tr>
            </table>
        </div>
        <div class="row"><h2>Rate Limiting</h2></div>
        <table>
            <tr>
                <td>Rate Window &nbsp;&nbsp;</td>
                <td id="window"></td>

            </tr>
            <tr>
                <td>Limit</td>
                <td id="limit"></td>
            </tr>
        </table>

        <hr class="hr">
<div class="footer"><input type="button" class="btn btn-" value="Logout" onclick="logOut()"><p></p><br><br></div>

    </div>
</div>
<div class="row">
</div><br><br>
<div class="container"><article></article></div>



<script src="./assets/js/core/jquery.min.js" type="text/javascript"></script>
<script src="./assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="./assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
<script src="./assets/js/plugins/moment.min.js"></script>
<!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
<script src="./assets/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
<!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
<script src="./assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
<!--  Google Maps Plugin    -->
<!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
<script src="./assets/js/material-kit.js?v=2.0.7" type="text/javascript"></script>

<script type="application/javascript">
	<!-- Check whether login is success-->
	async function check_login() {
		var token = await localStorage.getItem("x-access-token");
		if (!token){
			$("body").empty();
            alert("Not authorized, please sign in!");
			window.location.href = "./index.html";
		}
	}
	check_login();

	 function validateIPHost(data){
		return  /^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/.test(data);
	}

	async function getRoutesTable(){
		const url = "../proxy";
		let options = {
			method: 'GET', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
                'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
		};
		let response =  await fetch(url, options);
		let json_response = await response.json();
		for (let i = 0; i < json_response.length; i++) {
			let routeTableStructure =
				`<div class="col-md-5">
                <div class="card">
                    <table class="table table-stripe">
                        <tr><td>Name</td><td>${Object.keys(json_response[i].pathRewrite)[0].toString().slice(2, -1)}</td></tr>
                        <tr><td>Target</td><td>${json_response[i].target}</td></tr>
                        <tr><td>changeOrigin</td><td>${json_response[i].changeOrigin}</td></tr>
                        <tr><td>ws</td><td>${json_response[i].ws}</td></tr>
                        <tr><td>pathRewrite:</td><td></td></tr>
                        <tr><td>${Object.keys(json_response[i].pathRewrite)[0]}</td><td>${Object.values(json_response[i].pathRewrite)[0]}</td></tr>
                        <tr><td><input class="btn btn-danger" type="button" value="Delete Route"></td><td></td></tr>
                    </table>
                </div>
            </div>`;
            console.log(routeTableStructure);
           $(routeTableStructure).appendTo("#configuredRoutes")
		}





    }
    async function getBlackList(){
		const url = "../iplist/blacklist";
		let options = {
			method: 'GET', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
		};
		let response =  await fetch(url, options);
		let json_response = await response.json();
		for (let i = 0; i < json_response.length; i++) {
            let template=
                `<li>${json_response[i]}</li>`;
            $(template).appendTo("#blackList");
            console.log(json_response)
		}

    }
    async function getWhiteList(){
		const url = "../iplist/whitelist";
		let options = {
			method: 'GET', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
		};
		let response =  await fetch(url, options);
		let json_response = await response.json();
		for (let i = 0; i < json_response.length; i++) {
			let template=
				`<li>${json_response[i]}</li>`;
			$(template).appendTo("#whiteList");
			console.log(json_response)
		}
    }
    async function getRateLimit(){
		const url = "../ratelimit";
		let options = {
			method: 'GET', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
		};
		let response =  await fetch(url, options);
		let json_response = await response.json();
		let rate = await json_response.rate.toString();
		let win = await json_response.window.toString();

		$(`<h6>${win/60000} min</h6>`).appendTo("#window");
		$(`<h6>${rate} req</h6>`).appendTo("#limit");
		console.log( await json_response)
    }

	$(document).ready( function() {
		getRoutesTable();
		getBlackList();
		getWhiteList();
		getRateLimit();
	});

	async function addNewRoute() {
		let target = $('#route-target').val();
		let changeOrigin = $('#route-changeOrigin').val() === "true";
		let ws = $('#route-ws').val() === "true";
		let fromPath = $('#route-pathKey');
        let toPath = $('#route-pathVal');

        let data = {
        	target: target,
            changeOrigin: changeOrigin,
            ws: ws,
			pathRewrite:{}
        };
        data.pathRewrite[fromPath] = toPath;
		const url = "../proxy";
		let options = {
			method: 'POST', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer',
            body: JSON.stringify({object:data})
        };
		let response =  await fetch(url, options);
		if (response.status === 200){
			// alert("Route added successfully");
        }
		let json_response = await response.json();
		console.log(json_response);
		alert(JSON.stringify(json_response))

	}

	function deleteRoute() {

	}
	async function addIPtoBlackList() {
		let ip = $('#addBlackListIp').val();
		if (!validateIPHost(ip)){
			alert("Invalid IP/ Host name");
			return
        }
		let token = await localStorage.getItem("x-access-token")
        //console.log(token)
		console.log(ip);
		const url = "../iplist/blacklist";
		let options = {
			method: 'POST', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': token
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer',
			body: JSON.stringify({ip:ip})
		};
		let response =  await fetch(url, options);
		if (response.status === 201 || response.status === 200){
			alert("Successfully added "+ip+" to blacklist")
        }else{
			alert("Error occurred")
        }


	}
	async function removeIPFromBlackList() {
		let ip = $('#removeBlackListIp').val();
		if (!validateIPHost(ip)){
			alert("Invalid IP/ Host name");
			return
		}
		console.log(ip);
		const url = "../iplist/blacklist";
		let options = {
			method: 'DELETE', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer',
			body: JSON.stringify({ip:ip})
		};
		let response =  await fetch(url, options);
		if (response.status === 200){
			alert("Successfully removed "+ip+" from blacklist")
		}else{
			alert("Error occurred")
		}
	}
	async function addIPtoWhiteList() {
		let ip = $('#addWhiteListIp').val();
		console.log(ip);
		if (!validateIPHost(ip)){
			alert("Invalid IP/ Host name");
			return
		}

		const url = "../iplist/whitelist";
		let options = {
			method: 'POST', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer',
			body: JSON.stringify({ip:ip})
		};
		let response =  await fetch(url, options);
		if (response.status === 201 || response.status === 200){
			alert("Successfully added "+ip+" to whitelist")
		}else{
			alert("Error occurred")
		}
	}
	async function removeIPFromWhitelist() {
		let ip = $('#removeBlackListIp').val();
		console.log(ip);
		if (!validateIPHost(ip)){
			alert("Invalid IP/ Host name");
			return
		}
		const url = "../iplist/whitelist";
		let options = {
			method: 'DELETE', // *GET, POST, PUT, DELETE, etc.
			mode: 'cors', // no-cors, *cors, same-origin
			cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
			credentials: 'same-origin', // include, *same-origin, omit
			headers: {
				'Content-Type': 'application/json',
				'x-access-token': await localStorage.getItem("x-access-token")
			},
			redirect: 'follow', // manual, *follow, error
			referrerPolicy: 'no-referrer',
			body: JSON.stringify({ip:ip})
		};
		let response =  await fetch(url, options);
		if (response.status === 200){
			alert("Successfully removed "+ip+" from whitelist")
		}else{
			alert("Error occurred");

            console.log()
		}
	}
	
	function logOut() {
		 localStorage.removeItem("x-access-token");
         window.location.href = "./welcome.html";

	}
</script>

</body>
</html>